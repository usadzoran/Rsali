<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Facturation - Gestion Produits</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    h2 { color: #333; }
    input, button, select {
      margin: 5px 0; padding: 8px; width: 100%;
      box-sizing: border-box;
    }
    .section {
      background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>

  <h2>ðŸ“¦ Gestion des Produits</h2>

  <div class="section">
    <h3>âž• Ajouter un Produit</h3>
    <input id="codebar" placeholder="Code barre" />
    <input id="nom" placeholder="Nom du produit" />
    <input id="prix" type="number" placeholder="Prix unitaire (DA)" />
    <button onclick="ajouterProduit()">Ajouter</button>
    <div id="produitsList"></div>
  </div>

  <div class="section">
    <h3>ðŸ§¾ CrÃ©er une Facture</h3>
    <input id="clientNom" placeholder="Nom du client" />
    <input id="clientAdresse" placeholder="Adresse du client" />
    <select id="produitSelect"></select>
    <input id="quantite" type="number" placeholder="QuantitÃ©" value="1"/>
    <button onclick="ajouterLigneFacture()">Ajouter au panier</button>
    <table id="panierTable">
      <thead>
        <tr><th>Produit</th><th>Prix</th><th>QuantitÃ©</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Total: <span id="total">0</span> DA</h3>
    <button onclick="genererFacture()">ðŸ“„ GÃ©nÃ©rer PDF</button>
  </div>

  <!-- PDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let produits = JSON.parse(localStorage.getItem('produits') || '[]');
    let panier = [];

    function saveProduits() {
      localStorage.setItem('produits', JSON.stringify(produits));
    }

    function ajouterProduit() {
      const codebar = document.getElementById('codebar').value.trim();
      const nom = document.getElementById('nom').value.trim();
      const prix = parseFloat(document.getElementById('prix').value);
      if (!codebar || !nom || isNaN(prix)) return alert('Remplir tous les champs !');
      produits.push({ codebar, nom, prix });
      saveProduits();
      afficherProduits();
      remplirSelectProduits();
    }

    function afficherProduits() {
      const div = document.getElementById('produitsList');
      div.innerHTML = "<strong>Produits enregistrÃ©s:</strong><ul>" + produits.map(p => `<li>${p.nom} - ${p.prix} DA</li>`).join('') + "</ul>";
    }

    function remplirSelectProduits() {
      const select = document.getElementById('produitSelect');
      select.innerHTML = produits.map((p, i) => `<option value="${i}">${p.nom} (${p.prix} DA)</option>`).join('');
    }

    function ajouterLigneFacture() {
      const index = parseInt(document.getElementById('produitSelect').value);
      const quantite = parseInt(document.getElementById('quantite').value);
      if (isNaN(quantite) || quantite <= 0) return alert('QuantitÃ© invalide');
      const produit = produits[index];
      panier.push({ nom: produit.nom, prix: produit.prix, quantite });
      afficherPanier();
    }

    function afficherPanier() {
      const tbody = document.querySelector('#panierTable tbody');
      tbody.innerHTML = panier.map(p =>
        `<tr><td>${p.nom}</td><td>${p.prix}</td><td>${p.quantite}</td><td>${p.prix * p.quantite}</td></tr>`
      ).join('');
      const total = panier.reduce((s, p) => s + p.prix * p.quantite, 0);
      document.getElementById('total').innerText = total;
    }

    async function genererFacture() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const nom = document.getElementById('clientNom').value.trim();
      const adresse = document.getElementById('clientAdresse').value.trim();
      if (!nom || !adresse || panier.length === 0) return alert("ComplÃ©tez tous les champs et ajoutez des produits.");

      doc.setFontSize(16);
      doc.text("ðŸ§¾ Facture", 105, 15, null, null, "center");
      doc.setFontSize(12);
      doc.text(`Client: ${nom}`, 10, 30);
      doc.text(`Adresse: ${adresse}`, 10, 37);

      let y = 50;
      doc.text("Produit", 10, y);
      doc.text("Prix", 80, y);
      doc.text("QuantitÃ©", 110, y);
      doc.text("Total", 150, y);
      y += 7;

      panier.forEach(p => {
        doc.text(p.nom, 10, y);
        doc.text(p.prix.toString(), 80, y);
        doc.text(p.quantite.toString(), 110, y);
        doc.text((p.prix * p.quantite).toString(), 150, y);
        y += 7;
      });

      const total = panier.reduce((s, p) => s + p.prix * p.quantite, 0);
      doc.text(`Total Ã  payer: ${total} DA`, 10, y + 10);
      doc.save(`facture-${nom}.pdf`);
    }

    afficherProduits();
    remplirSelectProduits();
  </script>
</body>
</html>
